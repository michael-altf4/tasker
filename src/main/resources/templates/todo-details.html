<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>–ó–∞–¥–∞—á–∞: <span th:text="${todo.title}"></span></title>
  <link rel="stylesheet" href="/css/style.css" />
  <style>
    .detail-container {
      max-width: 600px;
      margin: 40px auto;
      padding: 20px;
      border: 1px solid #eee;
      border-radius: 8px;
      background: #fafafa;
    }
    .detail-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    .detail-title {
      font-size: 24px;
      margin: 0 auto;
      color: #333;
    }
    .edit-btn {
      background: none;
      border: none;
      font-size: 18px;
      cursor: pointer;
      color: #007bff;
      margin-left: 10px;
      padding: 0;
    }
    .edit-btn:hover {
      color: #0056b3;
    }
    .detail-created {
      font-size: 14px;
      color: #666;
      margin-bottom: 20px;
    }
    .detail-description {
      margin: 15px 0;
    }
    .detail-description p {
      margin: 0 0 10px 0;
      line-height: 1.5;
      white-space: pre-wrap;
      background: #f9f9f9;
      padding: 12px;
      border-radius: 4px;
      border: 1px solid #eee;
    }
    .priority-container {
      margin: 15px 0;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .priority-label {
      font-weight: bold;
    }
    .priority-select {
      padding: 6px 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 14px;
    }
    .btn-close {
      padding: 10px 16px;
      background: #dc3545;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    .btn-close:hover {
      background: #c82333;
    }
    .back-link {
      display: inline-block;
      margin-bottom: 20px;
      color: #007bff;
      text-decoration: none;
    }
    .back-link:hover {
      text-decoration: underline;
    }
    .form-inline {
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    .comment-container {
      padding: 12px 0;
      border-bottom: 1px solid #eee;
    }
    .comment-header {
      width: 100%;
      margin-bottom: 10px;
      font-size: 14px;
      color: #666;
    }
    .comment-date,
    .comment-controls {
      display: inline-block;
    }
    .comment-controls {
      float: right;
    }
    .comment-text {
      display: block;
      clear: both;
      padding: 10px;
      background-color: #f9f9f9;
      border-radius: 4px;
      line-height: 1.5;
      word-wrap: break-word;
      text-align: left;
      margin-top: 10px;
    }
  </style>
</head>
<script>
  // –ò–∑–≤–ª–µ–∫–∞–µ–º ID –∑–∞–¥–∞—á–∏ –∏–∑ URL: /todo/5 ‚Üí 5
  const currentTodoId = window.location.pathname.split('/').pop();

  // –ë–∞–∑–æ–≤—ã–π URL –¥–ª—è API
  const API_URL = 'http://localhost:8080/api/todos';
  const COMMENTS_API_URL = 'http://localhost:8080/api/comments';

  // ========== –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞–∑–≤–∞–Ω–∏–µ–º ==========
  function showTitleEdit() {
    document.getElementById('titleText').style.display = 'none';
    document.getElementById('titleEditForm').style.display = 'block';
  }

  function hideTitleEdit() {
    document.getElementById('titleEditForm').style.display = 'none';
    document.getElementById('titleText').style.display = 'block';
  }

  // ========== –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ–ø–∏—Å–∞–Ω–∏–µ–º ==========
  function showEditForm() {
    document.getElementById('editForm').style.display = 'block';
  }

  function hideEditForm() {
    document.getElementById('editForm').style.display = 'none';
  }

  // ========== –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–º ==========
  function showPriorityForm() {
    document.getElementById('priorityForm').style.display = 'flex';
    document.getElementById('priorityText').style.display = 'none';
    document.querySelector('.priority-container').style.alignItems = 'flex-start';
  }

  function hidePriorityForm() {
    document.getElementById('priorityForm').style.display = 'none';
    document.getElementById('priorityText').style.display = 'inline';
    document.querySelector('.priority-container').style.alignItems = 'center';
  }

  // ========== –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ ==========
  function loadComments() {
    if (!currentTodoId || isNaN(currentTodoId)) return;

    fetch(`${COMMENTS_API_URL}/todo/${currentTodoId}`)
            .then(response => {
              if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏');
              return response.json();
            })
            .then(comments => {
              const container = document.getElementById('commentsContainer');
              container.innerHTML = '';

              comments.forEach(comment => {
                const div = document.createElement('div');
                div.className = 'comment-container';

                // –®–∞–ø–∫–∞: –¥–∞—Ç–∞ + –∫–Ω–æ–ø–∫–∏
                const headerDiv = document.createElement('div');
                headerDiv.className = 'comment-header';

                const dateSpan = document.createElement('span');
                dateSpan.className = 'comment-date';
                dateSpan.textContent = formatDateTime(comment.createdAt);

                const controlsDiv = document.createElement('div');
                controlsDiv.className = 'comment-controls';

                const editBtn = document.createElement('button');
                editBtn.textContent = '‚úèÔ∏è';
                editBtn.title = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å';
                editBtn.style.padding = '2px 6px';
                editBtn.style.fontSize = '12px';
                editBtn.onclick = () => startEditComment(comment.id, comment.text);

                const deleteBtn = document.createElement('button');
                deleteBtn.textContent = 'üóëÔ∏è';
                deleteBtn.title = '–£–¥–∞–ª–∏—Ç—å';
                deleteBtn.style.padding = '2px 6px';
                deleteBtn.style.fontSize = '12px';
                deleteBtn.onclick = () => deleteComment(comment.id);

                controlsDiv.appendChild(editBtn);
                controlsDiv.appendChild(deleteBtn);
                headerDiv.appendChild(dateSpan);
                headerDiv.appendChild(controlsDiv);

                // –¢–µ–∫—Å—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è
                const textDiv = document.createElement('div');
                textDiv.className = 'comment-text';
                textDiv.id = `comment-text-${comment.id}`;
                textDiv.innerHTML = escapeHtml(comment.text).replace(/\n/g, '<br>');

                // –°–æ–±–∏—Ä–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç
                div.appendChild(headerDiv);
                div.appendChild(textDiv);
                container.appendChild(div);
              });
            })
            .catch(err => {
              console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤:', err);
              document.getElementById('commentsContainer').innerHTML = '<div>–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</div>';
            });
  }

  function addComment() {
    const textInput = document.getElementById('newCommentText');
    const text = textInput.value.trim();
    if (!text) return;

    fetch(`${COMMENTS_API_URL}/todo/${currentTodoId}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ text })
    })
            .then(response => {
              if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è');
              return response.json();
            })
            .then(newComment => {
              textInput.value = '';
              loadComments(); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º
            })
            .catch(err => {
              console.error('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è:', err);
              alert('–ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π');
            });
  }

  function startEditComment(id, currentText) {
    const textSpan = document.getElementById(`comment-text-${id}`);
    textSpan.innerHTML = '';

    const input = document.createElement('input');
    input.type = 'text';
    input.id = `edit-input-${id}`;
    input.value = currentText;
    input.style.width = '100%';
    input.style.padding = '6px';
    input.style.marginBottom = '8px';
    input.style.border = '1px solid #ccc';
    input.style.borderRadius = '4px';

    const buttonsDiv = document.createElement('div');
    buttonsDiv.style.display = 'flex';
    buttonsDiv.style.gap = '8px';

    const saveBtn = document.createElement('button');
    saveBtn.textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
    saveBtn.style.padding = '4px 8px';
    saveBtn.style.fontSize = '12px';
    saveBtn.onclick = () => saveComment(id);

    const cancelBtn = document.createElement('button');
    cancelBtn.textContent = '–û—Ç–º–µ–Ω–∞';
    cancelBtn.style.padding = '4px 8px';
    cancelBtn.style.fontSize = '12px';
    cancelBtn.style.backgroundColor = '#ddd';
    cancelBtn.onclick = () => cancelEdit(id, currentText);

    buttonsDiv.appendChild(saveBtn);
    buttonsDiv.appendChild(cancelBtn);

    textSpan.appendChild(input);
    textSpan.appendChild(buttonsDiv);
  }

  function saveComment(id) {
    const input = document.getElementById(`edit-input-${id}`);
    const text = input.value.trim();
    if (!text) {
      alert('–¢–µ–∫—Å—Ç –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º');
      return;
    }

    fetch(`${COMMENTS_API_URL}/${id}`, {
      method: 'PUT',
      headers: { 'Content-Type': 'text/plain' },
      body: text
    })
            .then(response => {
              if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
              return response.json();
            })
            .then(() => loadComments())
            .catch(err => {
              console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è:', err);
              alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å');
            });
  }

  function cancelEdit(id, originalText) {
    const textSpan = document.getElementById(`comment-text-${id}`);
    textSpan.textContent = originalText;
  }

  function deleteComment(id) {
    if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π?')) return;

    fetch(`${COMMENTS_API_URL}/${id}`, { method: 'DELETE' })
            .then(() => loadComments())
            .catch(err => {
              console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è:', err);
              alert('–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å');
            });
  }

  // ========== –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ ==========
  function formatDateTime(isoString) {
    const date = new Date(isoString);
    return new Intl.DateTimeFormat('ru-RU', {
      day: '2-digit',
      month: '2-digit',
      year: 'numeric',
      hour: '2-digit',
      minute: '2-digit'
    }).format(date);
  }

  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  // ========== –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ ==========
  if (currentTodoId && !isNaN(currentTodoId)) {
    loadComments();
  } else {
    document.getElementById('commentsContainer').innerHTML = '<div>–û—à–∏–±–∫–∞: –∑–∞–¥–∞—á–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞</div>';
  }
</script>
<body>
<div class="detail-container">
  <a href="/" class="back-link">‚Üê –ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É</a>

  <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å –∫–Ω–æ–ø–∫–æ–π —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è -->
  <div class="detail-header">
    <h1 class="detail-title" id="titleText" th:text="${todo.title}"></h1>
    <button class="edit-btn" onclick="showTitleEdit()">‚úèÔ∏è</button>
  </div>

  <!-- –§–æ—Ä–º–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–∞–∑–≤–∞–Ω–∏—è (—Å–∫—Ä—ã—Ç–∞) -->
  <div id="titleEditForm" style="display: none; margin-bottom: 20px;">
    <form th:action="@{/todo/{id}/update-title(id=${todo.id})}" method="post">
      <input type="text" name="title" th:value="${todo.title}" style="width: 100%; padding: 8px; font-size: 16px;" required />
      <button type="submit" style="margin-top: 8px; padding: 6px 12px;">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      <button type="button" onclick="hideTitleEdit()" style="margin-left: 8px;">–û—Ç–º–µ–Ω–∞</button>
    </form>
  </div>

  <p class="detail-created">
    –°–æ–∑–¥–∞–Ω–∞: <span th:text="${#temporals.format(todo.createdAt, 'dd.MM.yyyy –≤ HH:mm')}"></span>
  </p>

  <!-- –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç -->
  <div class="priority-container" style="display: flex; align-items: center; gap: 10px; margin: 15px 0;" id="priorityContainer">
    <span class="priority-label">–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:</span>

    <!-- –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞ —Ç–µ–∫—Å—Ç–æ–º -->
    <span id="priorityText" style="font-weight: normal;">
<span th:text="${todo.priorityLabel}"></span>
    </span>

    <!-- –ö–∞—Ä–∞–Ω–¥–∞—à–∏–∫ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è -->
    <button class="edit-btn" onclick="showPriorityForm()" style="flex-shrink: 0;">‚úèÔ∏è</button>
  </div>

  <!-- –§–æ—Ä–º–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞ (—Å–∫—Ä—ã—Ç–∞) -->
  <div id="priorityForm" style="display: none; margin: 15px 0;">
    <form th:action="@{/todo/{id}/update-priority(id=${todo.id})}" method="post" style="display: flex; align-items: center; gap: 8px;">
      <select name="priority" class="priority-select">
        <option th:selected="${todo.priority == 'LOW'}" value="LOW">–ù–∏–∑–∫–∏–π</option>
        <option th:selected="${todo.priority == 'MEDIUM'}" value="MEDIUM">–°—Ä–µ–¥–Ω–∏–π</option>
        <option th:selected="${todo.priority == 'HIGH'}" value="HIGH">–í—ã—Å–æ–∫–∏–π</option>
      </select>
      <button type="submit" style="padding: 6px 10px; font-size: 14px;">‚úîÔ∏è</button>
      <button type="button" onclick="hidePriorityForm()" style="margin-left: 8px;">–û—Ç–º–µ–Ω–∞</button>
    </form>
  </div>

  <!-- –û–ø–∏—Å–∞–Ω–∏–µ -->
  <div class="detail-description">
    <!-- –ï—Å–ª–∏ –æ–ø–∏—Å–∞–Ω–∏–µ –ø—É—Å—Ç–æ–µ -->
    <div th:if="${todo.description == null or todo.description == ''}">
      <form th:action="@{/todo/{id}/update-description(id=${todo.id})}" method="post">
            <textarea name="description" rows="5" style="width: 100%; border: 1px solid #ccc; padding: 8px;"
                      placeholder="–í–≤–µ–¥–∏—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏..."></textarea>
        <button type="submit" style="margin-top: 10px; padding: 6px 12px;">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      </form>
    </div>

    <!-- –ï—Å–ª–∏ –æ–ø–∏—Å–∞–Ω–∏–µ –µ—Å—Ç—å -->
    <div th:unless="${todo.description == null or todo.description == ''}" style="display: flex; align-items: center; gap: 10px;">
      <p style="margin: 0; flex: 1; line-height: 1.5; white-space: pre-wrap; background: #f9f9f9; padding: 12px; border-radius: 4px; border: 1px solid #eee;"
         th:text="${todo.description}" id="descriptionText"></p>
      <button class="edit-btn" onclick="showEditForm()">‚úèÔ∏è</button>
    </div>

    <!-- –§–æ—Ä–º–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (—Å–∫—Ä—ã—Ç–∞) -->
    <div id="editForm" style="display: none; margin-top: 15px;">
      <form th:action="@{/todo/{id}/update-description(id=${todo.id})}" method="post">
            <textarea name="description" rows="5" style="width: 100%; border: 1px solid #ccc; padding: 8px;"
                      th:text="${todo.description}"></textarea>
        <button type="submit" style="margin-top: 10px; padding: 6px 12px;">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        <button type="button" onclick="hideEditForm()" style="margin-left: 8px;">–û—Ç–º–µ–Ω–∞</button>
      </form>
    </div>
  </div>

  <!-- –ö–Ω–æ–ø–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è -->
  <form th:action="@{/todo/{id}/close(id=${todo.id})}" method="post">
    <button type="submit" class="btn-close" th:unless="${todo.completed}">–ó–∞–∫—Ä—ã—Ç—å –∑–∞–¥–∞—á—É</button>
  </form>
  <p th:if="${todo.completed}" style="color: #28a745; font-weight: bold; margin-top: 10px;">‚úÖ –≠—Ç–∞ –∑–∞–¥–∞—á–∞ –∑–∞–∫—Ä—ã—Ç–∞</p>
</div>
<!-- –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ -->
<div style="margin: 30px 0; padding: 15px; border: 1px solid #eee; border-radius: 8px; background: #f9f9f9;">
  <h3>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</h3>

  <!-- –§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è -->
  <div style="margin-bottom: 15px;">
        <textarea id="newCommentText" rows="3" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;"
                  placeholder="–ù–∞–ø–∏—à–∏—Ç–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π..."></textarea>
    <button onclick="addComment()" style="margin-top: 8px; padding: 6px 12px;">–î–æ–±–∞–≤–∏—Ç—å</button>
  </div>

  <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ -->
  <div id="commentsContainer"></div>
</div>
</body>
</html>